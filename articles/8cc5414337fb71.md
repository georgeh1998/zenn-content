---
title: "retrofitとxml"
emoji: "😺"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["android", "kotlin", "retrofit", "okhttp"]
published: false
---

# はじめに

retrofit で xml をパースする方法です。

# 環境

以下のライブラリを使用します。

```gradle
implementation("com.squareup.retrofit2:retrofit:2.9.0")
```

# やること

1. Converter クラスを作る
2. (1)の Factory クラスを作る
3. Retrofit インスタンスに(2)を登録する

# 1. Converter クラスを作る

- `retrfit.Converter`を実装します。generics は一つ目が`okhttp3.ResponseBody`、二つ目が開発者が結果として受け取りたい独自のデータクラスになります。

```kt
class RssResponseConverter: Converter<ResponseBody, RssApiModel> {

    private val parser = JunctionParser()

    override fun convert(value: ResponseBody): RssApiModel {
        val bs = value.string().byteInputStream()
        return parser.parse(bs)
    }
}
```

# 2. Factory クラスを作る

```kt
class RssConverterFactory private constructor(): Converter.Factory() {
    override fun responseBodyConverter(
        type: Type,
        annotations: Array<out Annotation>,
        retrofit: Retrofit
    ): Converter<ResponseBody, *> {
        return RssResponseConverter()
    }

    companion object {
        fun create() = RssConverterFactory()
    }
}
```

# 3. Retrofit インスタンスに登録する

```kt
@Module
@InstallIn(SingletonComponent::class)
object NetworkModule {

    @Singleton
    @Provides
    fun provideXmlRetrofit(): Retrofit {
        return Retrofit.Builder()
            .baseUrl("YOUR-URL")
            .addConverterFactory(RssConverterFactory.create())
            .build()
    }
}
```
