---
title: "retrofitã¨xmlã¨XmlPullParser"
emoji: "ğŸ˜º"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["android", "kotlin", "retrofit", "okhttp", "xmlpullparser"]
published: true
---

# ã¯ã˜ã‚ã«

retrofit ã§ xml ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹æ–¹æ³•ã§ã™ã€‚
XmlPullParserè‡ªä½“ã®ä½¿ã„æ–¹ã‚‚ã‚ã‚Šã¾ã™ã€‚

# ç’°å¢ƒ

ä»¥ä¸‹ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

- `com.squareup.retrofit2`
- `org.xmlpull.v1.XmlPullParser`

# è¨˜äº‹ã®æµã‚Œ

ã¾ãšã¯ãŠãã‚‰ãå…¨å“¡ãŒå…±é€šã§ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ä»¥ä¸‹ã‚’èª¬æ˜ã—ã¾ã™ã€‚
1. Converter ã‚¯ãƒ©ã‚¹ã‚’ä½œã‚‹(å¤–å´ã ã‘)
2. (1)ã® Factory ã‚¯ãƒ©ã‚¹ã‚’ä½œã‚‹
3. Retrofit ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«(2)ã‚’ç™»éŒ²ã™ã‚‹

æ¬¡ã«å®Ÿéš›ã«xmlã‚’è§£æã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’ä½œã‚Šã¾ã™ã€‚ã“ã“ã¯ã©ã‚“ãªxmlã‚’è§£æã™ã‚‹ã‹ã«ã‚ˆã£ã¦å®Ÿè£…ãŒç•°ãªã‚Šã¾ã™ã€‚


# 1. Converter ã‚¯ãƒ©ã‚¹ã‚’ä½œã‚‹

- `retrfit.Converter`ã‚’å®Ÿè£…ã—ã¾ã™ã€‚generics ã¯ä¸€ã¤ç›®ãŒ`okhttp3.ResponseBody`ã€äºŒã¤ç›®ãŒé–‹ç™ºè€…ãŒçµæœã¨ã—ã¦å—ã‘å–ã‚ŠãŸã„ç‹¬è‡ªã®ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ©ã‚¹ã«ãªã‚Šã¾ã™ã€‚
- `YourConverter`ã¯å®Ÿéš›ã«xmlã‚’è§£æã™ã‚‹å‡¦ç†ã‚’å«ã¿ã¾ã™ã€‚(å¾Œè¿°)

```kt
class YourResponseConverter: Converter<ResponseBody, YourModel> {

    private val parser = YourConverter()

    override fun convert(value: ResponseBody): YourModel {
        val bs = value.string().byteInputStream()
        return parser.parse(bs)
    }
}
```

# 2. Factory ã‚¯ãƒ©ã‚¹ã‚’ä½œã‚‹

```kt
class YourConverterFactory private constructor(): Converter.Factory() {
    override fun responseBodyConverter(
        type: Type,
        annotations: Array<out Annotation>,
        retrofit: Retrofit
    ): Converter<ResponseBody, *> {
        return YourResponseConverter()
    }

    companion object {
        fun create() = YourConverterFactory()
    }
}
```

# 3. Retrofit ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ç™»éŒ²ã™ã‚‹

ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç”Ÿæˆã¯hiltã‚’æƒ³å®šã—ã¦è¨˜è¿°ã—ã¦ã„ã¾ã™ãŒã€ä½•ã§ã‚‚å¤§ä¸ˆå¤«ã§ã™ã€‚
```kt
@Module
@InstallIn(SingletonComponent::class)
object NetworkModule {

    @Singleton
    @Provides
    fun provideXmlRetrofit(): Retrofit {
        return Retrofit.Builder()
            .baseUrl("YOUR-URL")
            .addConverterFactory(YourConverterFactory.create())
            .build()
    }
}
```


# XMLPullParserã§XMLã‚’è§£æã™ã‚‹ã€‚

## parserã®æº–å‚™

ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ã¾ã™ã€‚`input`ã¯`byteStream`ã«ãªã‚Šã¾ã™ã€‚

```kt
val parser = Xml.newPullParser()
parser.setFeature(XmlPullParser.FEATURE_PROCESS_NAMESPACES, false)
parser.setInput(input, null)
```

## parserã‚’æ¬¡ã®ã‚¿ã‚°ã¸ç§»å‹•ã™ã‚‹


`nextTag()`ãƒ¡ã‚½ãƒƒãƒ‰ã§parserã‚’æ¬¡ã®ã‚¿ã‚°ã«ç§»å‹•ã—ã¾ã™ã€‚
ã“ã®æ™‚ä»¥ä¸‹ã®ã‚ˆã†ã«`require`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã‚ã’ã‚‹ã¨ã€`rss`ã¨ã„ã†ã‚¹ã‚¿ãƒ¼ãƒˆã‚¿ã‚°ã«ã„ã‚‹ã“ã¨ã‚’ä¿éšœã—ã¦ãã‚Œã¾ã™ã€‚
```kt
parser.nextTag()
parser.require(XmlPullParser.START_TAG, null, "rss")
```

ä»¥ä¸‹ã®ã‚ˆã†ãªå ´åˆã€ã€Œä»Šã‚³ã‚³ã€ã‹ã‚‰ã€Œæ¬¡ã‚³ã‚³ã€ã«ç§»å‹•ã—ã¾ã™ã€‚
```xml
<!-- ä»Šã‚³ã‚³ -->
<rss> <!-- æ¬¡ã‚³ã‚³ -->
<channel>
xxx
</channel>
</rss>
```

## ä¸¦åˆ—ã®ã‚¿ã‚°ã‚’å…¨ã¦å·¡å›ã™ã‚‹

ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¿ã‚°ãŒã‚ã‚‹ã¨ã—ã¾ã™ã€‚
:::details ä¸¦åˆ—ã‚¿ã‚°ã®xmlã®ä¾‹
```xml
<title>xxx</title> <!-- ä»Šã“ã“ -->
<description>xxxã®ãƒ•ã‚£ãƒ¼ãƒ‰ã§ã™ã€‚</description>
<link>https://zenn.dev/xxx</link>
<image>
    <url>xxx</url>
    <title>xxxã•ã‚“ã®ãƒ•ã‚£ãƒ¼ãƒ‰</title>
    <link>https://zenn.dev/xxx</link>
</image>
<language><![CDATA[ ja ]]></language>
<item>
    <title>xxx1</title>
    <description>xxx1</description>
    <link>https://zenn.dev/xxx1</link>
</item>
<item>
    <title>xxx2</title>
    <description>xxx2</description>
    <link>https://zenn.dev/xxx2</link>
</item>
```
:::

`next`é–¢æ•°ã¯æ¬¡ã®è¦ç´ ã¸ç§»å‹•ã—ã¾ã™ã€‚(â€»ã‚¿ã‚°ã§ã¯ãªãã€æ¬¡ã®è¦ç´ ã§ã™ã€‚)
parserã®ä½ç½®ã«ã¯ç¨®é¡ãŒã‚ã‚Šã€ã‚ˆãä½¿ç”¨ã™ã‚‹ã®ã¯ã€æ—¢ã«ä½•åº¦ã‹å‡ºã¦ã„ã‚‹ã‚¿ã‚°ã®é–‹å§‹ã‚’è¡¨ã™`START_TAG`ã€ã‚¿ã‚°ã®çµ‚äº†ã‚’è¡¨ã™`END_TAG`ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ã™`TEXT`ãªã©ã§ã™ã€‚
`END_TAG`ã«ãªã‚‹ã¾ã§ãƒ«ãƒ¼ãƒ—ã™ã‚‹ã“ã¨ã§ã€ã‚¿ã‚°ã‚’å…¨ã¦å·¡å›ã§ãã¾ã™ã€‚ã¾ãŸã‚¿ã‚°ã®é–‹å§‹ã¯é€šå¸¸ã¯å¸¸ã«`START_TAG`ãªã®ã§ã€ãã‚Œä»¥å¤–ã¯continueã—ã¾ã™ã€‚

ãªãŠå„ã‚¿ã‚°ã‚’èª­ã¿è¾¼ã‚“ã éš›ã¯`nextTag()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã‚“ã§ãŠãã€å¿…ãš1ãƒ«ãƒ¼ãƒ—ãŒ`START_TAG`ã§çµ‚ã‚ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚(æ¬¡ã§èª¬æ˜)
```kt
while (parser.next() != XmlPullParser.END_TAG) {
    if (parser.eventType != XmlPullParser.START_TAG) {
        continue
    }
    // å–å¾—ã—ãŸã‚¿ã‚°åã«ã‚ˆã£ã¦ã€å‡¦ç†ã‚’åˆ†å²ã™ã‚‹ã€‚
    // ä¸è¦ãªã‚¿ã‚°ã¯ã€å¾Œè¿°ã™ã‚‹æ–¹æ³•ã§skipã™ã‚‹ã€‚
    when (parser.name) {
        "title" -> readTitle(parser)
        "item" -> readItem(parser) 
        else -> skip()
    }
}
```

## ã‚¿ã‚°å†…ã®è¦ç´ ã‚’èª­ã¿å–ã‚‹

ä»¥ä¸‹ã®ã‚ˆã†ãªxmlãŒã‚ã‚Šã€titleã‚¿ã‚°ã®é–‹å§‹ä½ç½®ã«ã„ã‚‹ã¨ã—ã¾ã™ã€‚
```xml
<title> <!-- ä»Šã‚³ã‚³ -->
    xxxã•ã‚“ã®ãƒ•ã‚£ãƒ¼ãƒ‰
</title>
```

é–‹å§‹ã‚¿ã‚°ã«ã„ã‚‹çŠ¶æ…‹ã§ã€`next()`ã‚’å‘¼ã¶ã¨æ¬¡ã®è¦ç´ ã«ç§»å‹•ã—ã¾ã™ã€‚ã“ã‚Œã¯Textã‚¿ã‚¤ãƒ—ãªã®ã§ã€`text`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å‘¼ã¶ã“ã¨ã§ã€ä¸­èº«ã‚’å–å¾—ã§ãã¾ã™ã€‚
ä¸­èº«ã‚’èª­ã¿è¾¼ã‚“ã å¾Œã¯ã“ã®ã‚¿ã‚°ã¯ç”¨æ¸ˆã¿ãªã®ã§ã€`nextTag()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã¶ã“ã¨ã§ã€æ¬¡ã®é–‹å§‹ã‚¿ã‚°ã«ç§»å‹•ã—ã¦ãŠãã¾ã™ã€‚
```kt
fun readTitle(parser: XmlPullParser): String {
    parser.require(XmlPullParser.START_TAG, null, "title")
    var result = ""
    if (parser.next() == XmlPullParser.TEXT) {
        result = parser.text
        parser.nextTag()
    }
    parser.require(XmlPullParser.END_TAG, null, tag)
    return result
}
```

## ä¸è¦ãªã‚¿ã‚°ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
ã‚¿ã‚°ã®å·¡å›ä¸­ã«ä¸è¦ãªã‚¿ã‚°ãŒã‚ã‚‹å ´åˆã€ã‚¹ã‚­ãƒƒãƒ—ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã§ã™ã€‚`START_TAG`ãŒã‚ã£ãŸã‚‰depthã‚’+1ã€`END_TAG`ãŒã‚ã£ãŸã‚‰depthã‚’-1ã¨ã—ã€depthãŒ0ã«ãªã£ãŸã‚‰ãã®ã‚¿ã‚°ã¯çµ‚äº†ã®ãŸã‚å®Ÿè³ªã‚¹ã‚­ãƒƒãƒ—ã—ãŸã“ã¨ã«ãªã‚Šã¾ã™ã€‚
ãªãŠå˜ç´”ã«`nextTag()`ã‚’å‘¼ã¶ã ã‘ã§ã¯ã ã‚ãªã®ã‹ï¼Ÿã¨æ€ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ã‚¿ã‚°ãŒãƒã‚¹ãƒˆã•ã‚Œã¦ã„ã‚‹å ´åˆã¯`nextTag()`ã§ã¯ãƒã‚¹ãƒˆã«å…¥ã‚Šè¾¼ã‚“ã§æ¬¡ã®ã‚¿ã‚°ã«ç§»å‹•ã™ã‚‹ã®ã§ã€ã ã‚ã§ã™ã€‚
```kt
fun skip(parser: XmlPullParser) {
    if (parser.eventType != XmlPullParser.START_TAG) {
        throw ParseException("")
    }
    var depth = 1
    while (depth != 0) {
        when (parser.next()) {
            XmlPullParser.END_TAG -> depth--
            XmlPullParser.START_TAG -> depth++
        }
    }
}
```

# çµ‚ã‚ã‚Šã«
ã“ã‚Œã§Feedç³»ã®ã‚¢ãƒ—ãƒªã‚’ä½œã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ğŸ˜
ã¿ãªã•ã‚“ã¯ã©ã‚“ãªã‚µãƒ¼ãƒ“ã‚¹ã§è‰²ã€…ãªã‚µã‚¤ãƒˆã®æœ€æ–°æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ï¼Ÿslackã¨ã‹ï¼Ÿlineã¨ã‹ï¼Ÿ
ãã‚Œã¨ã‚‚è‡ªä½œã®Feedã‚¢ãƒ—ãƒªã§ã™ã‹ãƒ»ãƒ»ãƒ»ï¼Ÿ

# å‚è€ƒ

- XmlPullParserã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
https://developer.android.com/training/basics/network-ops/xml?hl=ja#consume

- Retrofitã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
https://square.github.io/retrofit/