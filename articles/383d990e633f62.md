---
title: "Jetpack Composeã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é€£å‹•ã•ã›ã‚‹"
emoji: "ðŸ—‚"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["android", "kotlin", "jetpackcompose", "coordinatorlayout"]
published: false
---

# ã¯ã˜ã‚ã«

[Coordinatorlayout](https://developer.android.com/jetpack/androidx/releases/coordinatorlayout)ã‚’ Jetpack Compose ã§å®Ÿè£…ã—ãŸã„ï¼
[ã„ã‚ã„ã‚ãª CoordinatorLayout ãƒ‘ã‚¿ãƒ¼ãƒ³](https://qiita.com/ymshun/items/190527ffff55356ffb9e)ã§ç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã«ã€CoordinatorLayout ã¨è¨€ã£ã¦ã‚‚è‰²ã€…ãªç¨®é¡žãŒã‚ã‚Šã¾ã™ã€‚
ã“ã®è¨˜äº‹ã§ã¯ã€ã€Œç”»é¢ã®ä¸‹ã«ç§»å‹•ã™ã‚‹ã¨ãƒ˜ãƒƒãƒ€ãƒ¼ãŒæ¶ˆãˆã‚‹ã€ç”»é¢ã®ä¸Šã«ç§»å‹•ã™ã‚‹ã¨ã©ã®ä½ç½®ã§ã‚‚ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€ã¨ã„ã†ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ Jetpack Compose ã§ä½œæˆã—ã¦ã¿ã¾ã™ã€‚

@[youtube](Ju_ivS2o5fM)

ã‚³ãƒ¼ãƒ‰ã¯ä¸‹è¨˜ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚ã‚Šã¾ã™ã®ã§ã‚ˆã‹ã£ãŸã‚‰ç¢ºèªã—ã¦ã¿ã ãã•ã„ã€‚

@[card](https://github.com/goutarouh/LazyListHeader)

# LazyLayout ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é‡ã‚’è¨ˆç®—ã—ã‚ˆã†

å‰è¿°ã®é€šã‚Šã€CoordinatorLayout ã¨è¨€ã£ã¦ã‚‚ã€ã„ãã¤ã‹ã®ç¨®é¡žãŒã‚ã‚Šã¾ã™ã€‚
ã—ã‹ã—åŸºæœ¬çš„ã« LazyColumn ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é‡ã«å¿œã˜ã¦ã€ç‰¹å®šã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ã‚µã‚¤ã‚ºã‚„è¦‹ãŸç›®ãŒå¤‰æ›´ã•ã‚Œã¾ã™ã€‚
ãªã®ã§ LazyColumn ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é‡ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å–å¾—ã§ãã‚Œã°è‰¯ã„ã®ã§ã™ã€‚
ã€€.
ã€€.
LazyColumn ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é‡ã‚’ç°¡å˜ã«è¨ˆç®—ã™ã‚‹æ–¹æ³•ãŒãªã„ã®ã§ã™ã€‚(ã‚ã£ãŸã‚‰æ•™ãˆã¦ãã ã•ã„ï½ž)
ãã‚“ãªç§ã¯ `LazyListState` ã‹ã‚‰ã”ã‚ŠæŠ¼ã—ã—ã¦ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é‡ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å–å¾—ã™ã‚‹é–¢æ•°ã‚’å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸã€‚
ã—ã‹ã—ãã®å¾Œã€`Modifier.scrollable` ä½¿ã£ã¦ã¿ãŸã‚‰ã‚‚ã£ã¨ã‚·ãƒ³ãƒ—ãƒ«ã«æ›¸ã‘ãã†ã ãªã¨æ€ã„å®Ÿè£…ã—ãŸã®ã§ã€å…ˆã«ã“ã¡ã‚‰ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
(`LazyListState`ã‹ã‚‰è¨ˆç®—ã™ã‚‹æ–¹æ³•ã¯ãŠã¾ã‘ã«è¼‰ã›ã¦ãŠãã¾ã™ã€‚)

```kotlin
val lazyState = rememberLazyListState()
val scrollableState = rememberScrollableState(consumeScrollDelta = {
    lazyState.scrollBy(-it)  // need coroutine scope
    it
})
LazyColumn(
    modifier = Modifier
        .scrollable(
            orientation = Orientation.Vertical,
            state = scrollableState
        ),
    state = lazyState,
    userScrollEnabled = false
) {
    ...
}
```

`Modifier.scrollable`ã‹ã‚‰å–å¾—ã—ãŸã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é‡ã«å¿œã˜ã¦ã€LazyColumn ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã¾ã™ã€‚
ã—ãŸãŒã£ã¦ã€LazyColumn ã®`userScrollEnabled`ã‚’ false ã«ã—ã¦ãŠãã¾ã™ã€‚ã“ã†ã™ã‚‹ã“ã¨ã§`ScrollableState`ã‹ã‚‰ç”Ÿã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é‡ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§ã™ã€‚(`scrollBy`ã¯ Coroutine ãŒå¿…è¦ã§ã™ãŒã€çœç•¥ã—ã¦ã„ã¾ã™ã€‚)
è‹¥å¹²ãƒˆãƒªãƒƒã‚­ãƒ¼ãªæ–¹æ³•ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

# header ã® position ã‚’æ›´æ–°ã—ã‚ˆã†

1. ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ã‚’ dp ã¨ px ã§ç”¨æ„ã™ã‚‹ã€‚(ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ãŒå‹•çš„ã®å ´åˆã¯ `Modifier..onSizeChanged` ãªã©ã‚’ä½¿ç”¨ã—ã¦é«˜ã•ã‚’å–å¾—ã—ãŸã‚‰ã§ OK ã ã¨ãŠã‚‚ã„ã¾ã™ã€‚)
2. ãƒ˜ãƒƒãƒ€ãƒ¼ã® position ã‚’ State ã¨ã—ã¦ä¿æŒã™ã‚‹ã€‚æœ€åˆã®ä½ç½®ã‚’ 0 ã¨ã™ã‚‹ã€‚
3. `ScrollableState`ã®ãƒ©ãƒ ãƒ€ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã«å¿œã˜ã¦ã€headerPosition ã‚’æ›´æ–°ã™ã‚‹ã€‚ãã®ã¨ã`coerceIn`ã§ä¸Šé™ã¨ä¸‹é™ã‚’æ±ºã‚ã‚‹ã“ã¨ã§ã€ã€Œç”»é¢ã®ä¸‹ã«ç§»å‹•ã™ã‚‹ã¨ãƒ˜ãƒƒãƒ€ãƒ¼ãŒæ¶ˆãˆã‚‹ã€ç”»é¢ã®ä¸Šã«ç§»å‹•ã™ã‚‹ã¨ã©ã®ä½ç½®ã§ã‚‚ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€ã‚’é”æˆã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

```kotlin
val headerHeightDp = 49.dp
var headerPositionPx by remember { mutableStateOf(0) }
val density = LocalDensity.current
val headerHeightPx = with(density) { headerHeightDp.toPx() }.toInt()
val scrollableState = rememberScrollableState(consumeScrollDelta = {
    scope.launch { lazyState.scrollBy(-it) }
    headerPositionPx = (headerPositionPx + it.toInt()).coerceIn(-headerHeightPx, 0)
    it
})

Box(modifier = Modifier.fillMaxSize()) {
    LazyColumn(
        modifier = Modifier
            .scrollable(
                orientation = Orientation.Vertical,
                state = scrollableState
            ),
        contentPadding = PaddingValues(top = headerHeightDp),
        ...
    ) { ... }

    // Header
    Row(
        Modifier
            .offset { IntOffset(0, headerPositionPx) }
            .height(headerHeightDp)
    ) { ... }
}

```

# æˆæžœç‰©

:::details å…¨ä½“ã®ã‚³ãƒ¼ãƒ‰

```kotlin
@Composable
fun ComposeCoordinateLayoutSample() {
    val lazyState = rememberLazyListState()
    val scope = rememberCoroutineScope()
    val headerHeight = 56.dp
    var headerPositionPx by remember { mutableStateOf(0) }
    val density = LocalDensity.current
    val headerHeightPx = with(density) { headerHeight.toPx() }.toInt()
    val scrollableState = rememberScrollableState(consumeScrollDelta = {
        scope.launch { lazyState.scrollBy(-it) }
        headerPositionPx = (headerPositionPx + it.toInt()).coerceIn(-headerHeightPx, 0)
        it
    })

    Box(modifier = Modifier.fillMaxSize()) {
        LazyColumn(
            modifier = Modifier
                .fillMaxSize()
                .scrollable(
                    orientation = Orientation.Vertical,
                    state = scrollableState
                ),
            contentPadding = PaddingValues(top = headerHeightDp),
            state = lazyState,
            userScrollEnabled = false
        ) {
            lazyItems()
        }
        Row(
            Modifier
                .offset { IntOffset(0, headerPositionPx) }
                .height(headerHeightDp)
                .fillMaxWidth()
                .background(Color(0xFFEEEEEE))
            , horizontalArrangement = Arrangement.Center
            , verticalAlignment = Alignment.CenterVertically
        ) {
            Text(text = "HEADER")
        }
    }
}
```

:::

# ã¾ã¨ã‚

`Modifier.scrollable`ã‚’ä½¿ã£ã¦ã€å‰²ã¨ã™ã£ãã‚Šã¨æ›¸ãã“ã¨ãŒã§ãã¾ã—ãŸã€‚ã“ã®æ–¹æ³•ã‚’å¿œç”¨ã—ã¦ã€æ§˜ã€…ãª CoordinateLayout like ãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒä½œæˆã§ãã‚‹ã‹ãªã¨æ€ã„ã¾ã™ã€‚

ã“ã®è¨˜äº‹ã‚’æ›¸ã„ã¦ã„ã‚‹ã¨ãã«ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®[Migrate CoordinatorLayout to Compose](https://developer.android.com/jetpack/compose/migrate/migration-scenarios/coordinator-layout)ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚è¨˜äº‹ã«ã‚ˆã‚‹ã¨`In Compose, the closest equivalent of a CoordinatorLayout is a Scaffold.`ã¨ã®ã“ã¨ã§ã€Scaffold ã‚’ä½¿ç”¨ã—ã¦ã‚‚ä¼¼ãŸã‚ˆã†ãªå®Ÿè£…ãŒã§ãã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
(ã‚„ã£ãŸæ–¹ã„ãŸã‚‰æ•™ãˆã¦ãã ã•ã„...!)

ã„ãšã‚Œã«ã›ã‚ˆå…¬å¼ã‹ã‚‰ã€`CoordinatorLayout Compose` ã¿ãŸã„ãªã®ãŒå‡ºã‚Œã°æ¥½ã¡ã‚“ã§ã™ã­ã€‚

# ãŠã¾ã‘

### `LazyListState`ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é‡ã‹ã‚‰ HeaderPosition ã‚’è¨ˆç®—ã™ã‚‹

å ´åˆã«ã‚ˆã£ã¦ã¯ `LazyListState` ã‹ã‚‰å€¤ã‚’ã»ã˜ãã‚‹æ–¹æ³•ã‚‚ä½¿ãˆã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã¨ã‚Šã‚ãˆãšä¸‹è¨˜ã®å®Ÿè£…ã§ `Modifier.scrollable` ã‚’ä½¿ã£ãŸæ–¹æ³•ã¨åŒã˜ã‚ˆã†ãªå®Ÿè£…ã¯ã§ãã¾ã—ãŸãŒã€ã“ã£ã¡ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã¯ã‚ã¾ã‚Šã‚ˆããªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã€‚

:::details LazyListState ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é‡ã‹ã‚‰ HeaderPosition ã‚’è¨ˆç®—ã™ã‚‹

```kotlin
@Composable
fun LazyListState.headerPosition(headerHeightPx: Int): Int {
    var previousIndex = remember(this) { firstVisibleItemIndex }
    var previousScrollOffset = remember(this) { firstVisibleItemScrollOffset }
    var previousItemHeight = remember(this) { heightAtOrZero(firstVisibleItemIndex) }
    var scrollAmount = remember(this) { 0 }
    return remember(this) {
        derivedStateOf {
            scrollAmount += if (previousIndex == firstVisibleItemIndex) {
                firstVisibleItemScrollOffset - previousScrollOffset
            } else {
                if (previousIndex > firstVisibleItemIndex) {
                    val currentScroll = heightAtOrZero(firstVisibleItemIndex) - firstVisibleItemScrollOffset
                    -previousScrollOffset - currentScroll
                } else {
                    val lastScroll = previousItemHeight - previousScrollOffset
                    lastScroll + firstVisibleItemScrollOffset
                }
            }.also {
                previousIndex = firstVisibleItemIndex
                previousScrollOffset = firstVisibleItemScrollOffset
                previousItemHeight = heightAtOrZero(firstVisibleItemIndex)
            }
            scrollAmount = scrollAmount.coerceIn(0, headerHeightPx)
            scrollAmount
        }
    }.value
}


fun LazyListState.heightAtOrZero(index: Int): Int {
    return layoutInfo.visibleItemsInfo.firstOrNull { it.index == index }?.size ?: 0
}
```

:::
