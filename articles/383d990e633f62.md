---
title: "Jetpack Composeでスクロールとヘッダーを連動させる"
emoji: "🗂"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["android", "kotlin", "jetpackcompose", "coordinatorlayout"]
published: false
---

# はじめに

[Coordinatorlayout](https://developer.android.com/jetpack/androidx/releases/coordinatorlayout)を Jetpack Compose で実装したい！
[いろいろな CoordinatorLayout パターン](https://qiita.com/ymshun/items/190527ffff55356ffb9e)で紹介されているように、CoordinatorLayout と言っても色々な種類があります。
この記事では、「画面の下に移動するとヘッダーが消える、画面の上に移動するとどの位置でもヘッダーが表示される」というレイアウトを Jetpack Compose で作成してみます。

@[youtube](Ju_ivS2o5fM)

# LazyLayout のスクロール量を計算しよう

前述の通り、CoordinatorLayout と言っても、いくつかの種類があります。
しかし基本的に LazyColumn のスクロール量に応じて、特定のレイアウトのサイズや見た目が変更されます。
なので LazyColumn のスクロール量をリアルタイムで取得できれば良いのです。
　.
　.
LazyColumn のスクロール量を簡単に計算する方法がないのです。(あったら教えてください～)
そんな私は `LazyListState` からごり押しして現在のスクロール量をリアルタイムで取得する関数を実装してみました。
しかしその日の夢の中、誰かが教えてくれました。
「Modifier.scrollable 使ってみたら？」
　.
　.
ということで `Modifier.scrollable` を使う方法を説明します。
(`LazyListState`から計算する方法はおまけに載せておきます。)

```kotlin
val lazyState = rememberLazyListState()
val scrollableState = rememberScrollableState(consumeScrollDelta = {
    lazyState.scrollBy(-it)  // need coroutine scope
    it
})
LazyColumn(
    modifier = Modifier
        .scrollable(
            orientation = Orientation.Vertical,
            state = scrollableState
        ),
    state = lazyState,
    userScrollEnabled = false
) {
    ...
}
```

`Modifier.scrollable`から取得したスクロール量に応じて、LazyColumn をスクロールさせます。
したがって、LazyColumn の`userScrollEnabled`を false にしておきます。こうすることで`ScrollableState`から生のスクロール量を取得することができるのです。(`scrollBy`は Coroutine が必要ですが、省略しています。)
若干トリッキーな方法かもしれません。

# header の position を更新しよう

1. ヘッダーの高さを dp と px で用意する。(ヘッダーの高さが動的の場合はおまけを参考にしてみてください。)
2. ヘッダーの position を State として保持する。最初の位置を 0 とする。
3. `ScrollableState`のラムダでスクロールに応じて、headerPosition を更新する。そのとき`coerceIn`で上限と下限を決めることで、「画面の下に移動するとヘッダーが消える、画面の上に移動するとどの位置でもヘッダーが表示される」を達成することができる。

```kotlin
val headerHeightDp = 49.dp
var headerPositionPx by remember { mutableStateOf(0) }
val density = LocalDensity.current
val headerHeightPx = with(density) { headerHeightDp.toPx() }.toInt()
val scrollableState = rememberScrollableState(consumeScrollDelta = {
    scope.launch { lazyState.scrollBy(-it) }
    headerPositionPx = (headerPositionPx + it.toInt()).coerceIn(-headerHeightPx, 0)
    it
})

Box(modifier = Modifier.fillMaxSize()) {
    LazyColumn(
        modifier = Modifier
            .scrollable(
                orientation = Orientation.Vertical,
                state = scrollableState
            ),
        contentPadding = PaddingValues(top = headerHeightDp),
        ...
    ) { ... }

    // Header
    Row(
        Modifier
            .offset { IntOffset(0, headerPositionPx) }
            .height(headerHeightDp)
    ) { ... }
}

```

# 成果物

:::details 全体のコード

```kotlin
@Composable
fun ComposeCoordinateLayoutSample() {
    val lazyState = rememberLazyListState()
    val scope = rememberCoroutineScope()
    val headerHeight = 56.dp
    var headerPositionPx by remember { mutableStateOf(0) }
    val density = LocalDensity.current
    val headerHeightPx = with(density) { headerHeight.toPx() }.toInt()
    val scrollableState = rememberScrollableState(consumeScrollDelta = {
        scope.launch { lazyState.scrollBy(-it) }
        headerPositionPx = (headerPositionPx + it.toInt()).coerceIn(-headerHeightPx, 0)
        it
    })

    Box(modifier = Modifier.fillMaxSize()) {
        LazyColumn(
            modifier = Modifier
                .fillMaxSize()
                .scrollable(
                    orientation = Orientation.Vertical,
                    state = scrollableState
                ),
            contentPadding = PaddingValues(top = headerHeightDp),
            state = lazyState,
            userScrollEnabled = false
        ) {
            lazyItems()
        }
        Row(
            Modifier
                .offset { IntOffset(0, headerPositionPx) }
                .height(headerHeightDp)
                .fillMaxWidth()
                .background(Color(0xFFEEEEEE))
            , horizontalArrangement = Arrangement.Center
            , verticalAlignment = Alignment.CenterVertically
        ) {
            Text(text = "HEADER")
        }
    }
}
```

:::

# まとめ
